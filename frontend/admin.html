<!doctype html>
<html>
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin • EngageHubCoin</title>
  <style>
    body{font-family:Inter,system-ui;background:#0b1220;color:#e5e7eb;margin:0;padding:16px}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:16px;margin:12px 0}
    input,button,select,textarea{padding:10px;border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb}
    button.primary{background:#FFD700;color:#111827;border:none;font-weight:900;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2937;padding:8px;text-align:left;vertical-align:top}
    .muted{color:#9ca3af}
    code{background:#111827;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<div class="wrap">
  <h2>Admin</h2>

  <div class="card">
    <h3>Lookup User</h3>
    <div>
      <input id="adm_key" placeholder="ADMIN_SECRET"/>
      <input id="adm_uid" placeholder="user id e.g. facebook:123"/>
      <button class="primary" onclick="lookup()">Fetch</button>
    </div>
    <pre id="adm_out" class="muted" style="white-space:pre-wrap"></pre>
  </div>

  <div class="card">
    <h3>Pending Withdraw Requests</h3>
    <div>
      <input id="adm_key2" placeholder="ADMIN_SECRET"/>
      <button class="primary" onclick="listReqs()">Refresh</button>
    </div>
    <div id="reqs"></div>
  </div>

  <div class="card">
    <h3>Data Buyers (20 slots)</h3>
    <div class="muted">Update <code>status</code> (planned | active | paused) and <code>notes</code>.</div>
    <div>
      <input id="adm_key3" placeholder="ADMIN_SECRET"/>
      <button class="primary" onclick="loadBuyers()">Load</button>
    </div>
    <div id="buyers"></div>
  </div>

  <div class="card">
    <h3>Webhook Endpoints (copy to networks)</h3>
    <div class="muted">Each provider hits a GET URL with your chosen params. You may add a <code>?secret=YOUR_SECRET</code> if configured.</div>
    <ul>
      <li>/webhooks/cpx</li><li>/webhooks/bitlabs</li><li>/webhooks/adgem</li><li>/webhooks/tapjoy</li>
      <li>/webhooks/offertoro</li><li>/webhooks/persona.ly</li><li>/webhooks/ayet</li><li>/webhooks/kiwiwall</li>
      <li>/webhooks/offerdaddy</li><li>/webhooks/wannads</li><li>/webhooks/clickdealer</li><li>/webhooks/adwork</li>
      <li>/webhooks/maxbounty</li><li>/webhooks/cpalead</li><li>/webhooks/cj</li><li>/webhooks/rakuten</li>
      <li>/webhooks/impact</li><li>/webhooks/flexoffers</li><li>/webhooks/adscend</li><li>/webhooks/revenueuniverse</li>
      <li>/webhooks/adgate</li><li>/webhooks/adaction</li>
    </ul>
    <div class="muted">Typical params: <code>?user_id=USER&trans_id=UNIQUE&payout=1.25&secret=YOUR_SECRET</code></div>
  </div>
</div>

<script>
async function lookup(){
  const key=document.getElementById('adm_key').value.trim();
  const uid=document.getElementById('adm_uid').value.trim();
  const r=await fetch('/api/admin/user/'+encodeURIComponent(uid)+'?key='+encodeURIComponent(key));
  const j=await r.json(); document.getElementById('adm_out').textContent=JSON.stringify(j,null,2);
}
async function listReqs(){
  const key=document.getElementById('adm_key2').value.trim();
  const r=await fetch('/api/admin/withdraw/requests?key='+encodeURIComponent(key));
  const j=await r.json();
  const box=document.getElementById('reqs');
  box.innerHTML=(j.items||[]).map(it=>`
    <div style="border:1px solid #1f2937;border-radius:10px;padding:8px;margin:6px 0">
      <b>#${it.id}</b> · ${it.user_id} · $${it.amount.toFixed(2)} → ${it.email}
      <div class="muted">status: ${it.status}</div>
      <button onclick="pay(${it.id})" class="primary">Pay via PayPal</button>
    </div>
  `).join('') || '<div class="muted">None.</div>';
}
async function pay(id){
  const key=document.getElementById('adm_key2').value.trim();
  const r=await fetch('/api/admin/payouts/paypal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({admin_secret:key, request_id:id})});
  const j=await r.json(); alert(j.ok?'Paid ✅':'Error: '+(j.error||'failed'));
  listReqs();
}

/* Data buyers */
async function loadBuyers(){
  const r=await fetch('/api/data-buyers'); const j=await r.json();
  const box=document.getElementById('buyers');
  box.innerHTML = `
    <table>
      <thead><tr><th>ID</th><th>Name</th><th>Homepage</th><th>Status</th><th>Notes</th><th>Save</th></tr></thead>
      <tbody>
      ${ (j.items||[]).map(b=>`
        <tr>
          <td>${b.id}</td>
          <td>${b.name}</td>
          <td><a href="${b.homepage}" target="_blank">${b.homepage}</a></td>
          <td>
            <select id="st_${b.id}">
              ${["planned","active","paused"].map(s=>`<option ${s===b.status?"selected":""}>${s}</option>`).join('')}
            </select>
          </td>
          <td><textarea id="nt_${b.id}" rows="2" style="width:100%">${b.notes||""}</textarea></td>
          <td><button onclick="saveBuyer(${b.id})">Save</button></td>
        </tr>
      `).join('') }
      </tbody>
    </table>`;
}
async function saveBuyer(id){
  const key=document.getElementById('adm_key3').value.trim();
  const status=document.getElementById('st_'+id).value;
  const notes=document.getElementById('nt_'+id).value;
  const r=await fetch('/api/admin/data-buyers/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({admin_secret:key,id,status,notes})});
  const j=await r.json(); alert(j.ok?'Saved ✅':'Error');
}
</script>
</body>
</html>
