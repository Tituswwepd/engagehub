<!doctype html>
<html>
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EngageHubCoin</title>
  <link rel="icon" href="/assets/icon.png" type="image/png"/>
  <style>
    :root{
      --bg1:#0f172a; --bg2:#1e1b4b; --bg3:#4f46e5;
      --card:#0b1220; --border:#1f2937; --text:#e5e7eb; --muted:#9ca3af; --brand:#FFD700;
      --fb:#1877F2; --tt:#000000; --yt:#FF0000; --wa:#25D366; --x:#000; --ig:#E1306C;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2) 40%,var(--bg3));color:var(--text);font-family:Inter,system-ui}
    header{position:sticky;top:0;background:rgba(17,24,39,.75);backdrop-filter:blur(8px);padding:14px 18px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);z-index:10}
    header img{width:28px;height:28px;border-radius:50%}
    header b{font-size:16px;letter-spacing:.3px}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    input,button,select,textarea{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}
    button.primary{background:var(--brand);color:#111827;border:none;font-weight:900;cursor:pointer}
    .big{font-size:28px;font-weight:900;color:var(--brand);text-shadow:0 0 12px rgba(255,215,0,.25)}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    a.btn{display:inline-block;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:900}
    .btn-fb{background:var(--fb);color:#fff}
    .btn-tt{background:var(--tt);color:#fff;border:1px solid #222}
    .btn-x{background:var(--x);color:#fff;border:1px solid #222}
    .btn-ig{background:var(--ig);color:#fff}
    .btn-wa{background:var(--wa);color:#111}
    .yt-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .yt-card{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0a1020}
    .yt-thumb{width:100%;aspect-ratio:16/9;object-fit:cover;display:block}
    .yt-title{padding:8px;font-size:13px;line-height:1.2}
    .quiz-q{margin:8px 0 6px;font-weight:700}
    .quiz-opt{display:block;margin:6px 0;padding:8px;border:1px solid var(--border);border-radius:10px;background:#0b1220;cursor:pointer}
    .ok{color:#22c55e}.bad{color:#ef4444}
    .radio-item{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--border);border-radius:10px;margin:6px 0}
    audio{width:100%}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;cursor:pointer;background:#0a1020}
    .pill.active{background:#111a30;border-color:#2a3757}
    iframe.survey{width:100%;height:520px;border:1px solid var(--border);border-radius:12px;background:#000}
  </style>
</head>
<body>
  <header><img src="/assets/icon.png" alt="logo"/><b>EngageHubCoin</b></header>

  <main>
    <div class="grid">
      <!-- Auth -->
      <div class="card" style="grid-column:1/-1">
        <h3>Login / Register</h3>
        <div class="row">
          <input id="auth_email" placeholder="email" />
          <input id="auth_pass" type="password" placeholder="password" />
          <button class="primary" onclick="register()">Register</button>
          <button class="primary" onclick="login()">Login</button>
          <button onclick="logout()">Logout</button>
        </div>
        <div class="muted" id="auth_msg"></div>
      </div>

      <!-- Wallet -->
      <div class="card">
        <h3>Available to withdraw</h3>
        <div id="avail" class="big">—</div>
        <div class="row">
          <input id="uid" placeholder="your user id (only for guests)"/>
          <button class="primary" onclick="loadWallet()">Refresh</button>
        </div>
        <div class="muted">If logged in, your JWT account is used automatically. Guests can type a user id.</div>
      </div>

      <!-- Withdraw Request -->
      <div class="card">
        <h3>Request Withdrawal</h3>
        <div class="row"><input id="w_email" placeholder="PayPal email" style="flex:1"/></div>
        <div class="row"><input id="w_amount" placeholder="Amount (USD)" style="flex:1"/></div>
        <button class="primary" onclick="reqWithdraw()">Send request</button>
        <div id="wout" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- Deposit (PayPal / Card) -->
      <div class="card">
        <h3>Deposit (PayPal / Card)</h3>
        <div id="paypal-buttons"></div>
        <div class="muted">Top up with PayPal balance or credit/debit card.</div>
      </div>

      <!-- Social Connects -->
      <div class="card">
        <h3>Connect Accounts</h3>
        <div class="row">
          <a class="btn btn-fb" href="/auth/facebook">Facebook</a>
          <a class="btn btn-ig" href="/auth/instagram">Instagram</a>
          <a class="btn btn-tt" href="/auth/tiktok">TikTok</a>
          <a class="btn btn-x" href="/auth/twitter">X (Twitter)</a>
        </div>
        <div class="muted">Use these to personalize your experience and unlock more actions.</div>
      </div>

      <!-- WhatsApp -->
      <div class="card">
        <h3>WhatsApp</h3>
        <div class="row">
          <input id="wa_to" placeholder="Phone with country code e.g. 2547XXXXXXXX" style="flex:1"/>
        </div>
        <div class="row">
          <textarea id="wa_text" rows="3" placeholder="Your message..." style="flex:1"></textarea>
        </div>
        <button class="btn btn-wa" onclick="sendWhatsApp()">Send WhatsApp Message</button>
        <div id="wa_out" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- YouTube Feed -->
      <div class="card">
        <h3>Latest Videos</h3>
        <div id="yt" class="yt-grid"></div>
        <div id="yt-note" class="muted">Shows from your configured channel if a YouTube API key & channel are set.</div>
      </div>

      <!-- AI Quiz -->
      <div class="card">
        <h3>AI Quiz</h3>
        <div class="row">
          <input id="quiz_topic" placeholder="topic e.g. general, tech, Kenya"/>
          <select id="quiz_n"><option>5</option><option>7</option><option>10</option></select>
          <button class="primary" onclick="startQuiz()">Start</button>
        </div>
        <div id="quiz_box" style="margin-top:8px"></div>
        <div id="quiz_msg" class="muted"></div>
      </div>

      <!-- Radio -->
      <div class="card">
        <h3>Radio</h3>
        <div class="row">
          <input id="radio_q" placeholder="Search stations e.g. kenya, sports, gospel" style="flex:1"/>
          <button class="primary" onclick="searchRadio()">Search</button>
        </div>
        <div id="radio_results" style="margin-top:8px"></div>
        <div class="muted">Powered by the public Radio Browser directory.</div>
      </div>

      <!-- Surveys & Offers -->
      <div class="card" style="grid-column:1/-1">
        <h3>Surveys & Offers</h3>
        <div class="muted" style="margin-bottom:6px">
          Pick a provider below. Rewards track automatically when networks post back to our webhooks.
        </div>
        <div id="survey_pills" class="row" style="margin-bottom:8px"></div>
        <iframe id="survey_frame" class="survey"></iframe>
        <div class="muted" style="margin-top:8px">
          Tip: Guests: enter a <b>User ID</b> above so credit links back to your wallet. Logged-in users don’t need it.
        </div>
      </div>
    </div>
  </main>

<!-- Hidden admin shortcut -->
<script src="/admin-shortcut.js"></script>

<script>
/* ===== JWT auth state & helpers ===== */
let AUTH = { token: localStorage.getItem('jwt') || null };

function authHeaders(base = {}) {
  return AUTH.token ? { ...base, Authorization: 'Bearer ' + AUTH.token } : base;
}

async function register(){
  const email = document.getElementById('auth_email').value.trim();
  const password = document.getElementById('auth_pass').value;
  const r = await fetch('/api/auth/register',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({email,password})
  });
  const j = await r.json();
  if(j.token){
    AUTH.token=j.token; localStorage.setItem('jwt', j.token);
    document.getElementById('auth_msg').textContent='Registered & logged in.';
  } else {
    document.getElementById('auth_msg').textContent=j.error||'failed';
  }
}

async function login(){
  const email = document.getElementById('auth_email').value.trim();
  const password = document.getElementById('auth_pass').value;
  const r = await fetch('/api/auth/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({email,password})
  });
  const j = await r.json();
  if(j.token){
    AUTH.token=j.token; localStorage.setItem('jwt', j.token);
    document.getElementById('auth_msg').textContent='Logged in.';
  } else {
    document.getElementById('auth_msg').textContent=j.error||'failed';
  }
}

function logout(){
  AUTH.token=null; localStorage.removeItem('jwt');
  document.getElementById('auth_msg').textContent='Logged out.';
}

/* ===== Public constants for survey walls (client-safe only) ===== */
const SURVEY = {
  cpx:    (uid) => `https://offers.cpx-research.com/index.php?app_id=YOUR_CPX_APP_ID&ext_user_id=${encodeURIComponent(uid)}`,
  bitlabs:(uid) => `https://web.bitlabs.ai/?uid=${encodeURIComponent(uid)}&token=YOUR_BITLABS_PUBLISHABLE_TOKEN`,
  adgem:  (uid) => `https://wall.adgem.com/wall/api?appid=YOUR_ADGEM_APP_ID&playerid=${encodeURIComponent(uid)}`,
  tapjoy: (uid) => `https://www.tapjoy.com/offerwall?appid=YOUR_TAPJOY_APP_ID&user_id=${encodeURIComponent(uid)}`,
  offertoro:(uid)=> `https://www.offertoro.com/ifr/show/YOUR_PUBLISHER_ID/${encodeURIComponent(uid)}/YOUR_PUBLIC_HASH`,
  personaly:(uid)=> `https://persona.ly/offerwall/?appid=YOUR_PERSONALY_APP_ID&userid=${encodeURIComponent(uid)}`,
  ayet:(uid)=> `https://www.ayetstudios.com/offerwall/?appid=YOUR_AYET_APP_ID&userid=${encodeURIComponent(uid)}`,
  kiwiwall:(uid)=> `https://www.kiwiwall.com/wall/YOUR_SITE_ID/${encodeURIComponent(uid)}`,
  offerdaddy:(uid)=> `https://offerdaddy.com/wall/YOUR_SITE_ID/${encodeURIComponent(uid)}`,
  wannads:(uid)=> `https://wall.wannads.com/wall?apiKey=YOUR_WANNADS_PUBLISHABLE_KEY&userId=${encodeURIComponent(uid)}`
};

/* ===== Build survey provider pills ===== */
const SURVEY_LIST = [
  ["cpx","CPX"],["bitlabs","BitLabs"],["adgem","AdGem"],["tapjoy","Tapjoy"],
  ["offertoro","OfferToro"],["personaly","Persona.ly"],["ayet","Ayet Studios"],
  ["kiwiwall","KiwiWall"],["offerdaddy","OfferDaddy"],["wannads","Wannads"]
];
(function renderSurveyPills(){
  const pills = document.getElementById('survey_pills');
  pills.innerHTML = SURVEY_LIST.map(([k,label]) =>
    `<button class="pill" data-k="${k}" onclick="openSurvey('${k}', this)">${label}</button>`
  ).join('');
})();
function openSurvey(key, el){
  const uidInput = document.getElementById('uid');
  const uid = (AUTH.token ? 'jwt' : (uidInput.value||'guest')); // logged-in users are tracked by server; guests must provide uid
  const urlBuilder = SURVEY[key];
  const frame=document.getElementById('survey_frame');
  if(!urlBuilder){ alert('Provider not configured'); return; }
  document.querySelectorAll('#survey_pills .pill').forEach(p=>p.classList.remove('active'));
  if(el) el.classList.add('active');
  frame.src = urlBuilder(uid);
}

/* ===== Wallet & Withdraw ===== */
async function loadWallet(){
  try{
    // Prefer JWT if logged in
    if (AUTH.token) {
      const r = await fetch('/api/wallet', { headers: authHeaders() });
      if (r.ok) {
        const j = await r.json();
        const f=(n)=> (typeof n==='number'? n.toFixed(2) : Number(n||0).toFixed(2));
        document.getElementById('avail').textContent='$ '+f(j.available_to_withdraw_usd);
        return;
      }
    }
    // Fallback for guests by user_id
    const uid=document.getElementById('uid').value||'guest';
    const r=await fetch('/api/wallet/'+encodeURIComponent(uid));
    const j=await r.json();
    const f=(n)=> (typeof n==='number'? n.toFixed(2) : Number(n||0).toFixed(2));
    document.getElementById('avail').textContent='$ '+f(j.available_to_withdraw_usd);
  }catch(e){
    document.getElementById('avail').textContent='—';
  }
}

async function reqWithdraw(){
  const email=document.getElementById('w_email').value.trim();
  const amount_usd=Number(document.getElementById('w_amount').value||0);
  if(!email||!amount_usd){document.getElementById('wout').textContent='Enter email and amount.';return;}
  const r=await fetch('/api/withdraw/request',{
    method:'POST',
    headers: authHeaders({'Content-Type':'application/json'}),
    body:JSON.stringify({email,amount_usd})
  });
  const j=await r.json();
  document.getElementById('wout').textContent=j.ok?'Request sent ✅':'Error: '+(j.error||'failed');
}

/* ===== PayPal Buttons (deposit) ===== */
(async () => {
  try {
    const cfg = await fetch('/api/config/public').then(r => r.json());
    if (!cfg.PAYPAL_CLIENT_ID) return;
    const s = document.createElement('script');
    s.src = 'https://www.paypal.com/sdk/js?client-id=' + encodeURIComponent(cfg.PAYPAL_CLIENT_ID) + '&currency=USD&intent=capture&enable-funding=card';
    s.onload = () => {
      paypal.Buttons({
        createOrder: async () => {
          const amount_usd = prompt('Deposit amount (USD):','5.00');
          const r = await fetch('/api/paypal/deposit/create',{
            method:'POST',
            headers: authHeaders({'Content-Type':'application/json'}),
            body:JSON.stringify({ amount_usd: Number(amount_usd||0) })
          });
          const j = await r.json(); return j.id;
        },
        onApprove: async (data) => {
          const r = await fetch('/api/paypal/deposit/capture',{
            method:'POST',
            headers: authHeaders({'Content-Type':'application/json'}),
            body:JSON.stringify({ order_id: data.orderID })
          });
          const j = await r.json(); alert('Deposit captured: $'+(j.captured_usd||0));
          loadWallet();
        },
        onError: (err)=>{ console.error(err); alert('Payment error.'); }
      }).render('#paypal-buttons');
    };
    document.head.appendChild(s);
  } catch(e){ console.error(e); }
})();

/* ===== WhatsApp Send ===== */
async function sendWhatsApp(){
  const to = document.getElementById('wa_to').value.trim();
  const text = document.getElementById('wa_text').value.trim();
  if(!to || !text){ document.getElementById('wa_out').textContent='Enter phone and message.'; return; }
  const r = await fetch('/api/whatsapp/send',{
    method:'POST',
    headers: authHeaders({'Content-Type':'application/json'}),
    body:JSON.stringify({ to, text })
  });
  const j = await r.json();
  document.getElementById('wa_out').textContent = j.ok ? 'Message sent ✅' : ('Error: ' + (j.error||'failed'));
}

/* ===== YouTube Feed ===== */
(async () => {
  try{
    const grid=document.getElementById('yt');
    const res=await fetch('/api/youtube/videos'); const data=await res.json();
    const items=data.items||[];
    if(!items.length){ document.getElementById('yt-note').textContent='No videos found (check API key/channel).'; return; }
    grid.innerHTML = items.map(i=>{
      const id = i.id.videoId || i.id.playlistId || i.id.channelId || '';
      const sn = i.snippet||{};
      const thumb = (sn.thumbnails?.medium?.url)|| (sn.thumbnails?.high?.url)||'';
      const title = sn.title||'';
      const url = id ? `https://www.youtube.com/watch?v=${id}` : '#';
      return `
        <a class="yt-card" href="${url}" target="_blank" rel="noopener">
          <img class="yt-thumb" src="${thumb}" alt="">
          <div class="yt-title">${title}</div>
        </a>
      `;
    }).join('');
  }catch(e){ console.error(e); }
})();

/* ===== AI Quiz ===== */
let quizState = { items:[], i:0, score:0 };
async function startQuiz(){
  const topic = document.getElementById('quiz_topic').value || 'general';
  const n = Number(document.getElementById('quiz_n').value||5);
  const r = await fetch('/api/ai/quiz',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({topic, n})});
  const j = await r.json();
  quizState = { items: j.items||[], i:0, score:0 };
  document.getElementById('quiz_msg').textContent = `Provider: ${j.provider||'local'}`;
  renderQuiz();
}
function renderQuiz(){
  const box = document.getElementById('quiz_box'); box.innerHTML='';
  const { items, i, score } = quizState;
  if(!items.length){ box.innerHTML='<div class="muted">No questions.</div>'; return; }
  if(i>=items.length){ box.innerHTML=`<div class="big">Score: ${score}/${items.length}</div>`; return; }
  const q = items[i];
  const qEl = document.createElement('div'); qEl.className='quiz-q'; qEl.textContent=(i+1)+'. '+q.q;
  box.appendChild(qEl);
  q.options.forEach((opt,idx)=>{
    const b=document.createElement('button');
    b.className='quiz-opt';
    b.textContent=opt;
    b.onclick=()=>{
      if(idx===q.answer){ quizState.score++; b.classList.add('ok'); }
      else{ b.classList.add('bad'); }
      setTimeout(()=>{ quizState.i++; renderQuiz(); }, 400);
    };
    box.appendChild(b);
  });
}

/* ===== Radio ===== */
async function searchRadio(){
  const q = document.getElementById('radio_q').value.trim() || 'kenya';
  const out = document.getElementById('radio_results');
  out.innerHTML = 'Searching...';
  try{
    const r = await fetch('/api/radio/search?q='+encodeURIComponent(q));
    const j = await r.json();
    if(!j.items || !j.items.length){ out.innerHTML = '<div class="muted">No stations found.</div>'; return; }
    out.innerHTML = j.items.map(s => `
      <div class="radio-item">
        <div style="flex:1">
          <div style="font-weight:700">${s.name}</div>
          <div class="muted">${s.country||''} · ${s.codec||''} · ${s.bitrate||''}kbps</div>
        </div>
        <a href="${s.homepage||'#'}" target="_blank" class="muted" style="text-decoration:none">site</a>
      </div>
      <audio controls src="${s.url}"></audio>
    `).join('');
  }catch(e){ out.innerHTML = '<div class="muted">Error searching radio.</div>'; }
}
</script>
</body>
</html>
